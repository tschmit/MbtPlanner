/**
 * @module MbtPlanner
 * @author thierry.schmit@gmail.com
 * @copyright Cabinet Camus Lebkiri (2019)
 * @license MIT
 * 
 * @overview dependencies:
 *    - required
 *        - jquery
 *    - optional
 *        - moment https://github.com/moment/moment/ 
 *        
 *  [samples](http://planner.madbuildertools.com/)
 */(function(a){"use strict";var h=Math.ceil;function b(a){return!!a&&"function"==typeof a.then}function c(a,c){a.startsWith("#")&&(a=a.substring(1));let d=document.getElementById(a);if(null===d){let b=document.getElementsByTagName("body")[0];d=document.createElement("div"),d.id=a,b.appendChild(d)}return $(d).hasClass("contextMenu")||$(d).addClass("contextMenu"),$("body").on("click",function(){$(d).css("display","none")}),function(e){var f=$("<ul>");$(d).html(""),c.forEach(c=>{if(c.visible){var d=$("<li>"+c.title+"</li>");d.on("click",async function(d){let e=c.action(c,d);b(e)&&(await e),$(a).css("display","none")}),f.append(d)}}),$(d).append(f),$(d).css("left",e.pageX-2+"px").css("top",e.pageY-2+"px").css("display","block"),e.preventDefault(),e.stopPropagation()}}/**
     * @constructor
     * @param {any} id Unique identifier of a DOM element that will be used as placeholder for the planner
     */function e(a){return a.getDay()||7}function f(a){return a.getFullYear()+"-"+("0"+(a.getMonth()+1).toString()).slice(-2)+"-"+("0"+a.getDate().toString()).slice(-2)}function g(a){if(!("string"==typeof a))"number"==typeof a&&(a=new Date(a));else if(a.startsWith("/Date("))a=new Date(parseInt(a.substr(6)));else{if(!/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(a))throw"day must be a yyyy-MM-dd string";return new Date(a)}if("function"!=typeof a.getFullYear)throw"parameter is not a date";return new Date(a.getFullYear().toString()+"-"+("0"+(a.getMonth()+1).toString()).slice(-2)+"-"+("0"+a.getDate().toString()).slice(-2))}/*
     * For testing purposes
     * */var j=new Date("2500-01-01"),k=function(a){if(window.jQuery===void 0)throw"jQuery required for MbtPlanner";/** 
         *  @property {array} Resources an array of 
         *  
         *  {
         *      Id: id,
         *      OutOfWorkDays: [], string XXXX-MM-DD
         *      ClosedIsoDays: [], int between 0 and 6. 7 is equivalent to 0 (sunday)
         *  }
         *  
         */ /**
         * @property {function} CustomFormatter function that returns a string from a Task object. Default:
         * 
         *     (task) => task.IRef + ": " + task.Code
         * */ /**
         * @property {function} CustomResourceFooter function that returns a string from a Resource object, and load aggregated value. Default:
         * 
         *     (r, load) => r.Id.toString() + ": " + load.toFixed(2)
         * */ //gestion d'erreur d'arrondie, on ne planifie pas cette fraction de jour:
//css inline line-height for the component
//for the svg experimental version
/**
         * @property {function} Save function that saves modified task completions. Default:
         * 
         *     null
         * */a.startsWith("#")||(a="#"+a),this.Id=a,this.ResetPlanner(),this.Resources=[],this.ClosedIsoDays=[6,7],this.OutOfWorkDays=[],this.ProgressStep=25,this.DefaultLoads=[],this.FirstIsoDayOfWeek=1,this.TodayChar="+",this.CustomFormatter=null,this.CustomResourceFooter=null,this.Resolution=16,this.fontSize=12,this.dayWidth=15,this.dayHeight=15,this.dayWGutter=2,this.dayHGutter=2,this.Save=null};k.prototype.SetSave=function(a){null==this.Save&&null!=a&&$(this.Id).on("contextmenu",c(this.Id+"m",[{visible:!0,title:"Save",action:async function(){let a=this.Save(this.GetDeltas());b(a)&&(await a)}.bind(this)}],null)),this.Save=a,null===this.Save&&$(this.Id).off("contextmenu")},k.prototype.GetEOW=()=>j,k.prototype.ResetPlanner=function(a=!1){$(this.Id).html(""),this.Tasks=[],a||(this.Resources=[]),this.MinDueDate=j,this.MaxDueDate=null,this.MaxDate=null,this.MinDate=null},k.prototype.GetDeltas=function(){var a=[];return this.Tasks.forEach(function(b){(0!=b.InitialExOrder-b.ExOrder||b.InitialCompletion!==b.Completion)&&a.push({Id:b.Id,InitialCompletion:b.InitialCompletion,CompletionDelta:b.Completion-b.InitialCompletion,InitialExOrder:b.InitialExOrder,ExOrderDelta:b.ExOrder-b.InitialExOrder})}),a},k.prototype.FormatTaskHeader=function(a){try{return null===this.CustomFormatter?a.IRef+": "+a.Code:this.CustomFormatter(a)}catch(a){return"formatting error"}},k.prototype.FormatResourceFooter=function(a,b){try{return null===this.CustomResourceFooter?a.Id.toString()+": "+b.toFixed(2):this.CustomResourceFooter(a,b)}catch(a){return"formatting error"}},k.prototype.LastIsoDayOfWeek=function(){return this.FirstIsoDayOfWeek-1||7},k.prototype.GetIsoWeekForWeekStartingAt=function(a){if(1!==this.FirstIsoDayOfWeek&&(a=new Date(a.valueOf()+864E5*(8-this.FirstIsoDayOfWeek))),void 0!==window.moment){var b=moment(f(a));return b.isoWeek()}var c=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate())),d=c.getUTCDay()||7;c.setUTCDate(c.getUTCDate()+4-d);var e=new Date(Date.UTC(c.getUTCFullYear(),0,1));return h(((c-e)/864E5+1)/7)},k.prototype.ResetPlannerAsync=function(a=!1){return new Promise(function(b){this.ResetPlanner(a),b(!0)}.bind(this))},k.prototype.QueryPlanAndDrawAsync=function(a,b,c,d,e,f,g=null,h=!1){return Promise.all([this.ResetPlannerAsync(h),$.ajax(a)]).then(function(a){var h=a[1];b(h)?c(h)?(null===g&&(g=a=>a.Data),this.AppendTasks(g(h),this.DefaultLoads),f!==void 0&&f(this,h),this.Plan("forward"),this.Draw(Date.now())):d(h):e()}.bind(this))},k.prototype.Draw=function(a,c){$(this.Id).hasClass("MbtPlanner")||$(this.Id).addClass("MbtPlanner"),$(this.Id).html("<div style='font-size:"+this.fontSize.toString()+"px;line-height:"+this.dayHeight.toString()+"px'><div style='display: flex;'><div class='Tasks'></div><div class='Planning'></div></div><div class='Messages'></div></div>");var d=Date.now();if(null===this.MaxDate)return void $(this.Id+" .Planning").html("<p>Nothing to display</p>");(c===void 0||null===c)&&(c="html;"),a===void 0||null===a?a=this.LastDrawMinDate:this.LastDrawMinDate=a;for(var j=void 0===a||null===a?this.MinDate>this.MinDueDate?this.MinDueDate:this.MinDate:g(a);e(j)!==this.FirstIsoDayOfWeek;)j=new Date(j.valueOf()-864E5);var k=this.MaxDate;this.Resources.forEach(function(a){a.OutOfWorkDays.forEach(function(a){a>k&&(k=a)})});for(//var weekCount = Math.ceil((this.MaxDate.valueOf() - startDate.valueOf()) / (7 * 864E5));
var l=h((k.valueOf()-j.valueOf())/604800000);e(k)!==this.LastIsoDayOfWeek();)k=new Date(k.valueOf()+864E5);var m=g(Date.now());let n=null,o=null,p=null;//la table
switch(c){case"svg-experimental":if(this.DrawSvgTasks===void 0)throw"svg not found";this.DrawSvgTasks(l,j);break;default:n=$("<table style='border-collapse:separate;border-spacing:1px 1px'><thead><tr><th>Tasks</th><th style='width:40px'></th><th style='width:30px'></th></tr></thead><tbody></tbody></table>");for(var q,s=n.find("thead").first(),u=n.find("tbody").first(),v=0,w=0;w<this.Tasks.length;w++){q=!1,w==this.Tasks.length-1?q=!0:null===this.Tasks[w].Resource?null!==this.Tasks[w+1].Resource&&(q=!0):null===this.Tasks[w+1].Resource?q=!0:this.Tasks[w].Resource.Id!==this.Tasks[w+1].Resource.Id&&(q=!0);let a="<div class='PBar' style='width: "+this.Tasks[w].Completion.toString()+"%'>"+this.FormatTaskHeader(this.Tasks[w])+"</div>";v+=this.Tasks[w].Load*(1-this.Tasks[w].Completion/100);let b=$("<tr data-taskid='"+this.Tasks[w].Id.toString()+"'><td>"+a+"</td><td>"+(this.Tasks[w].Load*(1-this.Tasks[w].Completion/100)).toFixed(2)+"</td><td>"+(q?"":"<span class='ActionB Back'>\u2193</span>")+"<span class='ActionB Complete'>&gt;</span></td></tr>");b.on("click","td:last-child span.Back",function(a){var b=$(a.target).closest("tr"),c=b.data("taskid"),d=this.Tasks.findIndex(function(a){return a.Id===c});if(-1!=d&&d!=this.Tasks.length-1){var e=this.Tasks[d].ExOrder;this.Tasks[d].ExOrder=this.Tasks[d+1].ExOrder,this.Tasks[d+1].ExOrder=e,this.Plan(),this.Draw()}}.bind(this)),b.on("click","td:last-child span.Complete",function(a){var b=$(a.target).closest("tr"),c=b.data("taskid"),d=this.Tasks.findIndex(function(a){return a.Id===c});100!==this.Tasks[d].InitialCompletion&&(100===this.Tasks[d].Completion?this.Tasks[d].Completion=this.Tasks[d].InitialCompletion:(this.Tasks[d].Completion+=this.ProgressStep,100<this.Tasks[d].Completion&&(this.Tasks[d].Completion=100)),this.Plan(),this.Draw())}.bind(this)),u.append(b),q&&(u.append("<tr><td colspan='2' style='text-align:right;'>"+this.FormatResourceFooter(this.Tasks[w].Resource,v)+"</tr>"),v=0)}$(this.Id+" .Tasks").html(n),u.on("click","td:first-child",a=>{a=a||window.event;var b=$(a.target||a.srcElement).closest("tr"),c=Array.prototype.indexOf.call(b[0].parentElement.children,b[0]);//alert(i);
b.toggleClass("SelectedRow"),$(this.Id+" .Planning tbody").children().eq(c).toggleClass("SelectedRow")});var r=Date.now()-d;n=$("<table style='border-collapse:separate;border-spacing:1px 1px'><thead></thead><tbody></tbody><tfoot></tfoot></table>"),s=n.find("thead").first(),u=n.find("tbody").first();var x=n.find("tfoot").first();n.css("width",this.dayWidth*(7*l).toString()+"px"),o=j;let a="<tr>";for(l=0,p=this.GetIsoWeekForWeekStartingAt(o);o<=k;)a+="<th colspan='7'>"+p.toString()+" : "+f(o)+"</th>",o=new Date(o.valueOf()+604800000),l++,p++,52<p&&(p=this.GetIsoWeekForWeekStartingAt(o));s.append(a+"</tr>"),x.append(a+"</tr>");var y=j,z="<tr>",A=-12587;let b=!1;for(w=0;w<this.Tasks.length;w++){let a=this.Tasks[w];a.Resource.Id!==A&&(-12587!==A&&u.append("<tr><td></td></tr>"),A=a.Resource.Id,y=j,z="<tr>");let c=y;b=!(0<a.Production.length);let d=z;for(var B="";c<=k;)//endDate
B=c.valueOf()===m.valueOf()?this.TodayChar:"",c.valueOf()===a.DueDate.valueOf()?(!b&&(b=!0,z=d,y=c),d+=this.IsOutOfWorkDay(c,a.Resource)?"<td class='DueDateOO'>"+B+"</td>":"<td class='DueDate'>"+B+"</td>"):this.IsOpenDay(c,a.Resource)?this.IsProductionDay(c,a)?(!b&&(b=!0,z=d,y=c),d+=c>a.DueDate?"<td class='AfterDueDate'>"+B+"</td>":void 0!==a.Resource.BC&&""!==a.Resource.BC?"<td style='background-color:"+a.Resource.BC+";'/>":"<td class='Worked'>"+B+"</td>"):this.IsOutOfWorkDay(c,a.Resource)?d+="<td class='OutOfWork'>"+B+"</td>":d+="<td>"+B+"</td>":d+="<td class='Closed'>"+B+"</td>",c=new Date(c.valueOf()+864E5);u.append($(d+"</tr>"))}u.append("<tr><td></td></tr>"),$(this.Id+" .Planning").html(n);}this.DrawingDuration=Date.now()-d,$(this.Id+" .Messages").html("Planning duration: "+this.PlanningDuration.toString()+", Drawing duration: "+r.toString()+" + "+(this.DrawingDuration-r).toString())},k.prototype.IsProductionDay=function(a,b){return-1!==b.Production.findIndex(function(b){return b.valueOf()===a.valueOf()})},k.prototype.IsOpenDay=function(a,b){var c=e(a);return!(-1!==this.ClosedIsoDays.indexOf(c))&&!(-1!==b.ClosedIsoDays.indexOf(c))},k.prototype.IsOutOfWorkDay=function(a,b){var c=-1!==this.OutOfWorkDays.findIndex(function(b){return b.valueOf()===a.valueOf()})||-1!==b.OutOfWorkDays.findIndex(function(b){return b.valueOf()===a.valueOf()});return c},k.prototype.AddToWorkableDay=function(a,b,c){if(a=g(a),"string"==typeof b&&(b=parseInt(b)),0>b){for(;d>a;)this.IsOpenDay(d,c)||(a=new Date(a.valueOf()-864E5)),d=new Date(d.valueOf()-864E5);for(;!this.IsOpenDay(a,c);)a=new Date(a.valueOf()-864E5)}else{for(;!this.IsOpenDay(a,c)||this.IsOutOfWorkDay(a,c);)a=new Date(a.valueOf()+864E5);var d=a;for(a=new Date(a.valueOf()+864E5*b);d<a;)(!this.IsOpenDay(a,c)||this.IsOutOfWorkDay(a,c))&&(a=new Date(a.valueOf()+864E5)),d=new Date(d.valueOf()+864E5)}return a},k.prototype.GetResource=function(a){void 0===a&&(a=null);let b=this.Resources.find(function(b){return b.Id===a});return void 0===b&&(b={Id:a,OutOfWorkDays:[],ClosedIsoDays:[]},this.Resources.push(b)),b},k.prototype.AppendTasks=function(a,b){for(var c=0;c<a.length;c++){if(void 0===a[c].Id||null===a[c].Id)continue;let i=this.Tasks.findIndex(b=>b.Id===a[c].Id);if(-1!==i)continue;if(void 0===a[c].Code||null===a[c].Code)continue;let l=this.GetResource(a[c].ResourceId);//.bind(this);
var d=null;if(void 0!==a[c].DueDate&&null!==a[c].DueDate){for(d=g(a[c].DueDate);!this.IsOpenDay(d,l);)d=new Date(d.valueOf()+864E5);(null===this.MaxDueDate||d>this.MaxDueDate)&&(this.MaxDueDate=d),d<this.MinDueDate&&(this.MinDueDate=d)}if(void 0===a[c].Load||null===a[c].Load)var e=0;else e="string"==typeof a[c].Load?parseFloat(a[c].Load):a[c].Load;if(void 0===a[c].IRef||null===a[c].IRef)var f="";else f=a[c].IRef;if(void 0===a[c].Completion||null===a[c].Completion)var h=0;else h=parseFloat(a[c].Completion),100<h&&(h=100);if(void 0===a[c].ExOrder||null===a[c].ExOrder)var k=null;else k="string"==typeof a[c].ExOrder?parseInt(a[c].ExOrder):a[c].ExOrder;var m={Id:a[c].Id,Resource:l,Label:a[c].Label,IRef:f,Code:a[c].Code,DueDate:d,InitialExOrder:k,ExOrder:k,Load:e,StartDate:null,EndDate:null,//Completion éditée via le planner
Completion:h,//completion déclarée par la source de données
InitialCompletion:h,OTask:a[c]};if(null===m.DueDate&&(m.DueDate=j),0===m.Load&&void 0!==b&&null!==b){let a=b.find(function(a){return a.Code===m.Code});m.Load=void 0===a?0:a.Load}this.Tasks.push(m)}},k.prototype.SortTasks=function(){this.Tasks.sort(function(c,a){if(null!==c.Resource){if(null===a.Resource)return-1;if(c.Resource.Id!==a.Resource.Id)return c.Resource.Id<a.Resource.Id?-1:1}else if(null!==a.Resource)return 1;if(null!==c.ExOrder){if(null===a.ExOrder)return-1;if(c.ExOrder!==a.ExOrder)return c.ExOrder<a.ExOrder?-1:1}else if(null!==a.ExOrder)return 1;return c.DueDate===j?a.DueDate===j?0:1:a.DueDate===j?-1:c.DueDate<a.DueDate?-1:1})},k.prototype.AppendOutOfWorkDay=function(a,b){if(b=g(b),"*"===a)-1===this.OutOfWorkDays.findIndex(function(a){return a.valueOf()===b.valueOf()})&&this.OutOfWorkDays.push(b);else{var c=this.GetResource(a);//.bind(this);
-1===c.OutOfWorkDays.findIndex(function(a){return a.valueOf()===b.valueOf()})&&c.OutOfWorkDays.push(b)}},k.prototype.AppendClosedIsoDay=function(a,b){if(1>b||7<b)throw"not an iso day";if("*"===a)-1===this.ClosedIsoDays.findIndex(function(a){return a===b})&&this.ClosedIsoDays.push(b);else{var c=this.GetResource(a);//.bind(this);
-1===c.ClosedIsoDays.findIndex(function(a){return a===b})&&c.ClosedIsoDays.push(b)}},k.prototype.SetBackGroundColor=function(a,b){var c=this.GetResource(a);//.bind(this);
c.BC=b},k.prototype.Plan=function(a,b){let c=100;var d=Date.now();switch(void 0===a||null===a?((void 0===this.LastDirection||null===this.LastDirection)&&(this.LastDirection="forward"),a=this.LastDirection):this.LastDirection=a,void 0===b||null===b?((void 0===this.LastFrom||null===this.LastFrom)&&(this.LastFrom=g(new Date(Date.now()+864E5))),b=this.LastFrom):(b=g(b),this.LastFrom=b),this.SortTasks(),this.MinDate=null,this.MaxDate=null,this.Resources.forEach(function(a){a.NextWorkableDay=this.AddToWorkableDay(b,0,a),a.dayResidue=100}.bind(this)),this.Tasks.forEach(function(a){a.StartDate=null,a.EndDate=null,a.Production=[]}),a){case"forward":var e=1;for(let a=0;a<this.Tasks.length;a++){var f=this.Tasks[a];null===f.ExOrder?(f.ExOrder=e++,f.InitialExOrder=f.ExOrder):e=f.ExOrder+1,f.DueDate!==j&&(null===this.MaxDate||f.DueDate>this.MaxDate)&&(this.MaxDate=f.DueDate);let b=f.Load*c*(1-f.Completion/100);for(f.StartDate=f.Resource.NextWorkableDay;100<=b;)f.Production.push(f.Resource.NextWorkableDay),f.Resource.NextWorkableDay=this.AddToWorkableDay(f.Resource.NextWorkableDay,1,f.Resource),b-=100;//scale / this.Resolution <=> fraction de journée qui ne doit pas être planifiée
b>c/this.Resolution&&(f.Production.push(f.Resource.NextWorkableDay),b>f.Resource.dayResidue?(f.Resource.NextWorkableDay=this.AddToWorkableDay(f.Resource.NextWorkableDay,1,f.Resource),f.Production.push(f.Resource.NextWorkableDay),f.Resource.dayResidue=f.Resource.dayResidue+100-b):f.Resource.dayResidue-=b,0===f.Resource.dayResidue&&(f.Resource.NextWorkableDay=this.AddToWorkableDay(f.Resource.NextWorkableDay,1,f.Resource),f.Resource.dayResidue=100)),f.EndDate=0<f.Production.length?f.Production[f.Production.length-1]:f.StartDate,(null===this.MaxDate||f.Resource.NextWorkableDay>this.MaxDate)&&(this.MaxDate=f.Resource.NextWorkableDay),(null===this.MinDate||f.StartDate<this.MinDate)&&(this.MinDate=f.StartDate)}}this.PlanningDuration=Date.now()-d},a.MbtPlanner=k;a.mbtpGetDate=g})(this);