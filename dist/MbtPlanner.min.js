/**
 * @module MbtPlanner
 * @author thierry.schmit@gmail.com
 * @copyright Cabinet Camus Lebkiri (2019)
 * @license MIT
 * 
 * @overview dependecies:
 *    - required
 *        - jquery
 *    - optional
 *        - moment https://github.com/moment/moment/ 
 *        
 *  [samples](http://planner.madbuildertools.com/)
 */(function(a){"use strict";var e=Math.ceil;function b(a){return a.getDay()||7}function c(a){return a.getFullYear()+"-"+("0"+(a.getMonth()+1).toString()).slice(-2)+"-"+("0"+a.getDate().toString()).slice(-2)}function d(a){if(!("string"==typeof a))"number"==typeof a&&(a=new Date(a));else if(a.startsWith("/Date("))a=new Date(parseInt(a.substr(6)));else{if(!/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(a))throw"day must be a yyyy-MM-dd string";return new Date(a)}if("function"!=typeof a.getFullYear)throw"parameter is not a date";return new Date(a.getFullYear().toString()+"-"+("0"+(a.getMonth()+1).toString()).slice(-2)+"-"+("0"+a.getDate().toString()).slice(-2))}/*
     * For testing purposes
     * */var f=new Date("2500-01-01"),g=function(a){if(window.jQuery===void 0)throw"jQuery required for MbtPlanner";/**
         * @property {function} CustomFormatter function that returns a string from a Task object. Default:
         * 
         *     (task) => task.IRef + ": " + task.Code
         * */ /**
         * @property {function} CustomResourceFooter function that returns a string from a Resource object, and load aggregated value. Default:
         * 
         *     (r, load) => r.Id.toString() + ": " + load.toFixed(2)
         * */ //gestion d'erreur d'arrondie, on ne planifie pas cette fraction de jour:
//css inline line-height for the component
//for the svg experimental version
a.startsWith("#")||(a="#"+a),this.Id=a,this.ResetPlanner(),this.ClosedIsoDays=[6,7],this.OutOfWorkDays=[],this.ProgressStep=25,this.DefaultLoads=[],this.FirstIsoDayOfWeek=1,this.TodayChar="+",this.CustomFormatter=null,this.CustomResourceFooter=null,this.Resolution=16,this.fontSize=12,this.dayWidth=15,this.dayHeight=15,this.dayWGutter=2,this.dayHGutter=2};/**
     * @constructor
     * @param {any} id Unique identifier of a DOM element that will be used as placeholder for the planner
     */g.prototype.GetEOW=()=>f,g.prototype.ResetPlanner=function(){$(this.Id).html(""),this.Tasks=[],this.Resources=[],this.MinDueDate=f,this.MaxDueDate=null,this.MaxDate=null,this.MinDate=null},g.prototype.GetDeltas=function(){var a=[];return this.Tasks.forEach(function(b){(0!=b.InitialExOrder-b.ExOrder||b.InitialCompletion!==b.Completion)&&a.push({Id:b.Id,InitialCompletion:b.InitialCompletion,CompletionDelta:b.Completion-b.InitialCompletion,InitialExOrder:b.InitialExOrder,ExOrderDelta:b.ExOrder-b.InitialExOrder})}),a},g.prototype.FormatTaskHeader=function(a){try{return null===this.CustomFormatter?a.IRef+": "+a.Code:this.CustomFormatter(a)}catch(a){return"formatting error"}},g.prototype.FormatResourceFooter=function(a,b){try{return null===this.CustomResourceFooter?a.Id.toString()+": "+b.toFixed(2):this.CustomResourceFooter(a)}catch(a){return"formatting error"}},g.prototype.LastIsoDayOfWeek=function(){return this.FirstIsoDayOfWeek-1||7},g.prototype.GetIsoWeekForWeekStartingAt=function(a){if(1!==this.FirstIsoDayOfWeek&&(a=new Date(a.valueOf()+864E5*(8-this.FirstIsoDayOfWeek))),void 0!==window.moment){var b=moment(c(a));return b.isoWeek()}var f=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate())),d=f.getUTCDay()||7;f.setUTCDate(f.getUTCDate()+4-d);var g=new Date(Date.UTC(f.getUTCFullYear(),0,1));return e(((f-g)/864E5+1)/7)},g.prototype.ResetPlannerAsync=function(){return new Promise(function(a){this.ResetPlanner(),a(!0)}.bind(this))},g.prototype.QueryPlanAndDrawAsync=function(a,b,c,d,e,f){return Promise.all([this.ResetPlannerAsync(),$.ajax(a)]).then(function(a){var g=a[1];b(g)?c(g)?(this.AppendTasks(g.Data,this.DefaultLoads),f!==void 0&&f(this),this.Plan("forward"),this.Draw(Date.now())):d(g):e()}.bind(this))},g.prototype.Draw=function(a,g){var j=Date.now();if(null===this.MaxDate)return void $(this.Id+" .Planning").html("<p>Nothing to display</p>");(g===void 0||null===g)&&(g="html;"),$(this.Id).hasClass("MbtPlanner")||$(this.Id).addClass("MbtPlanner"),$(this.Id).html("<div style='font-size:"+this.fontSize.toString()+"px;line-height:"+this.dayHeight.toString()+"px'><div style='display: flex;'><div class='Tasks'></div><div class='Planning'></div></div><div class='Messages'></div></div>"),a===void 0||null===a?a=this.LastDrawMinDate:this.LastDrawMinDate=a;for(var k=void 0===a||null===a?this.MinDate>this.MinDueDate?this.MinDueDate:this.MinDate:d(a);b(k)!==this.FirstIsoDayOfWeek;)k=new Date(k.valueOf()-864E5);var l=this.MaxDate,m=e((this.MaxDate.valueOf()-k.valueOf())/604800000);for(this.Resources.forEach(function(a){a.OutOfWorkDays.forEach(function(a){a>l&&(l=a)})});b(l)!==this.LastIsoDayOfWeek();)l=new Date(l.valueOf()+864E5);var n=d(Date.now());let o=null,p=null,q=null;//la table
switch(g){case"svg-experimental":if(this.DrawSvgTasks===void 0)throw"svg not found";this.DrawSvgTasks(m,k);break;default:o=$("<table style='border-collapse:separate;border-spacing:1px 1px'><thead><tr><th>Tasks</th><th style='width:40px'></th><th style='width:30px'></th></tr></thead><tbody></tbody></table>");for(var s,u=o.find("thead").first(),v=o.find("tbody").first(),w=0,x=0;x<this.Tasks.length;x++){s=!1,x==this.Tasks.length-1?s=!0:null===this.Tasks[x].Resource?null!==this.Tasks[x+1].Resource&&(s=!0):null===this.Tasks[x+1].Resource?s=!0:this.Tasks[x].Resource.Id!==this.Tasks[x+1].Resource.Id&&(s=!0);let a="<div class='PBar' style='width: "+this.Tasks[x].Completion.toString()+"%'>"+this.FormatTaskHeader(this.Tasks[x])+"</div>";w+=this.Tasks[x].Load*(1-this.Tasks[x].Completion/100);let b=$("<tr data-taskid='"+this.Tasks[x].Id.toString()+"'><td>"+a+"</td><td>"+(this.Tasks[x].Load*(1-this.Tasks[x].Completion/100)).toFixed(2)+"</td><td>"+(s?"":"<span class='ActionB Back'>\u2193</span>")+"<span class='ActionB Complete'>&gt;</span></td></tr>");b.on("click","td:last-child span.Back",function(a){var b=$(a.target).closest("tr"),c=b.data("taskid"),d=this.Tasks.findIndex(function(a){return a.Id===c});if(-1!=d&&d!=this.Tasks.length-1){var e=this.Tasks[d].ExOrder;this.Tasks[d].ExOrder=this.Tasks[d+1].ExOrder,this.Tasks[d+1].ExOrder=e,this.Plan(),this.Draw()}}.bind(this)),b.on("click","td:last-child span.Complete",function(a){var b=$(a.target).closest("tr"),c=b.data("taskid"),d=this.Tasks.findIndex(function(a){return a.Id===c});100!==this.Tasks[d].InitialCompletion&&(100===this.Tasks[d].Completion?this.Tasks[d].Completion=this.Tasks[d].InitialCompletion:(this.Tasks[d].Completion+=this.ProgressStep,100<this.Tasks[d].Completion&&(this.Tasks[d].Completion=100)),this.Plan(),this.Draw())}.bind(this)),v.append(b),s&&(v.append("<tr><td colspan='2' style='text-align:right;'>"+this.FormatResourceFooter(this.Tasks[x].Resource,w)+"</tr>"),w=0)}$(this.Id+" .Tasks").html(o);var r=Date.now()-j;o=$("<table style='border-collapse:separate;border-spacing:1px 1px'><thead></thead><tbody></tbody><tfoot></tfoot></table>"),u=o.find("thead").first(),v=o.find("tbody").first();var y=o.find("tfoot").first();o.css("width",this.dayWidth*(7*m).toString()+"px"),p=k;let a="<tr>";for(m=0,q=this.GetIsoWeekForWeekStartingAt(p);p<=l;)a+="<th colspan='7'>"+q.toString()+" : "+c(p)+"</th>",p=new Date(p.valueOf()+604800000),m++,q++,52<q&&(q=this.GetIsoWeekForWeekStartingAt(p));u.append(a+"</tr>"),y.append(a+"</tr>");var f=k,z="<tr>",A=-12587;let b=!1;for(x=0;x<this.Tasks.length;x++){let a=this.Tasks[x];a.Resource.Id!==A&&(-12587!==A&&v.append("<tr><td></td></tr>"),A=a.Resource.Id,f=k,z="<tr>");let c=f;b=!(0<a.Production.length);let d=z;for(var B="";c<=l;)//endDate
B=c.valueOf()===n.valueOf()?this.TodayChar:"",c.valueOf()===a.DueDate.valueOf()?(!b&&(b=!0,z=d,f=c),d+=this.IsOutOfWorkDay(c,a.Resource)?"<td class='DueDateOO'>"+B+"</td>":"<td class='DueDate'>"+B+"</td>"):this.IsOpenDay(c,a.Resource)?this.IsProductionDay(c,a)?(!b&&(b=!0,z=d,f=c),d+=c>a.DueDate?"<td class='AfterDueDate'>"+B+"</td>":void 0!==a.Resource.BC&&""!==a.Resource.BC?"<td style='background-color:"+a.Resource.BC+";'/>":"<td class='Worked'>"+B+"</td>"):this.IsOutOfWorkDay(c,a.Resource)?d+="<td class='OutOfWork'>"+B+"</td>":d+="<td>"+B+"</td>":d+="<td class='Closed'>"+B+"</td>",c=new Date(c.valueOf()+864E5);v.append($(d+"</tr>"))}v.append("<tr><td></td></tr>"),$(this.Id+" .Planning").html(o);}this.DrawingDuration=Date.now()-j,$(this.Id+" .Messages").html("Planning duration: "+this.PlanningDuration.toString()+", Drawing duration: "+r.toString()+" + "+(this.DrawingDuration-r).toString())},g.prototype.IsProductionDay=function(a,b){return-1!==b.Production.findIndex(function(b){return b.valueOf()===a.valueOf()})},g.prototype.IsOpenDay=function(a,c){var e=b(a);return!(-1!==this.ClosedIsoDays.indexOf(e))&&!(-1!==c.ClosedIsoDays.indexOf(e))},g.prototype.IsOutOfWorkDay=function(a,b){var c=-1!==this.OutOfWorkDays.findIndex(function(b){return b.valueOf()===a.valueOf()})||-1!==b.OutOfWorkDays.findIndex(function(b){return b.valueOf()===a.valueOf()});return c},g.prototype.AddToWorkableDay=function(a,b,c){if(a=d(a),"string"==typeof b&&(b=parseInt(b)),0>b){for(;e>a;)this.IsOpenDay(e,c)||(a=new Date(a.valueOf()-864E5)),e=new Date(e.valueOf()-864E5);for(;!this.IsOpenDay(a,c);)a=new Date(a.valueOf()-864E5)}else{for(;!this.IsOpenDay(a,c)||this.IsOutOfWorkDay(a,c);)a=new Date(a.valueOf()+864E5);var e=a;for(a=new Date(a.valueOf()+864E5*b);e<a;)(!this.IsOpenDay(a,c)||this.IsOutOfWorkDay(a,c))&&(a=new Date(a.valueOf()+864E5)),e=new Date(e.valueOf()+864E5)}return a},g.prototype.GetResource=function(a){void 0===a&&(a=null);let b=this.Resources.find(function(b){return b.Id===a});return void 0===b&&(b={Id:a,OutOfWorkDays:[],ClosedIsoDays:[]},this.Resources.push(b)),b},g.prototype.AppendTasks=function(a,b){for(var c=0;c<a.length;c++){if(void 0===a[c].Id||null===a[c].Id)continue;if(void 0===a[c].Code||null===a[c].Code)continue;let i=this.GetResource(a[c].ResourceId);//.bind(this);
var e=null;if(void 0!==a[c].DueDate&&null!==a[c].DueDate){for(e=d(a[c].DueDate);!this.IsOpenDay(e,i);)e=new Date(e.valueOf()+864E5);(null===this.MaxDueDate||e>this.MaxDueDate)&&(this.MaxDueDate=e),e<this.MinDueDate&&(this.MinDueDate=e)}if(void 0===a[c].Load||null===a[c].Load)var g=0;else g="string"==typeof a[c].Load?parseFloat(a[c].Load):a[c].Load;if(void 0===a[c].IRef||null===a[c].IRef)var h="";else h=a[c].IRef;if(void 0===a[c].Completion||null===a[c].Completion)var j=0;else j=parseFloat(a[c].Completion),100<j&&(j=100);if(void 0===a[c].ExOrder||null===a[c].ExOrder)var k=null;else k="string"==typeof a[c].ExOrder?parseInt(a[c].ExOrder):a[c].ExOrder;var m={Id:a[c].Id,Resource:i,Label:a[c].Label,IRef:h,Code:a[c].Code,DueDate:e,InitialExOrder:k,ExOrder:k,Load:g,StartDate:null,EndDate:null,//Completion éditée via le planner
Completion:j,//completion déclarée par la source de données
InitialCompletion:j,OTask:a[c]};if(null===m.DueDate&&(m.DueDate=f),0===m.Load&&void 0!==b&&null!==b){let a=b.find(function(a){return a.Code===m.Code});m.Load=void 0===a?0:a.Load}this.Tasks.push(m)}},g.prototype.SortTasks=function(){this.Tasks.sort(function(c,a){if(null!==c.Resource){if(null===a.Resource)return-1;if(c.Resource.Id!==a.Resource.Id)return c.Resource.Id<a.Resource.Id?-1:1}else if(null!==a.Resource)return 1;if(null!==c.ExOrder){if(null===a.ExOrder)return-1;if(c.ExOrder!==a.ExOrder)return c.ExOrder<a.ExOrder?-1:1}else if(null!==a.ExOrder)return 1;return c.DueDate===f?a.DueDate===f?0:1:a.DueDate===f?-1:c.DueDate<a.DueDate?-1:1})},g.prototype.AppendOutOfWorkDay=function(a,b){if(b=d(b),"*"===a)-1===this.OutOfWorkDays.findIndex(function(a){return a.valueOf()===b.valueOf()})&&this.OutOfWorkDays.push(b);else{var c=this.GetResource(a);//.bind(this);
-1===c.OutOfWorkDays.findIndex(function(a){return a.valueOf()===b.valueOf()})&&c.OutOfWorkDays.push(b)}},g.prototype.AppendClosedIsoDay=function(a,b){if(1>b||7<b)throw"not an iso day";if("*"===a)-1===this.ClosedIsoDays.findIndex(function(a){return a===b})&&this.ClosedIsoDays.push(b);else{var c=this.GetResource(a);//.bind(this);
-1===c.ClosedIsoDays.findIndex(function(a){return a===b})&&c.ClosedIsoDays.push(b)}},g.prototype.SetBackGroundColor=function(a,b){var c=this.GetResource(a);//.bind(this);
c.BC=b},g.prototype.Plan=function(a,b){let c=100;var e=Date.now();switch(void 0===a||null===a?((void 0===this.LastDirection||null===this.LastDirection)&&(this.LastDirection="forward"),a=this.LastDirection):this.LastDirection=a,void 0===b||null===b?((void 0===this.LastFrom||null===this.LastFrom)&&(this.LastFrom=d(new Date(Date.now()+864E5))),b=this.LastFrom):(b=d(b),this.LastFrom=b),this.SortTasks(),this.MinDate=null,this.MaxDate=null,this.Resources.forEach(function(a){a.NextWorkableDay=this.AddToWorkableDay(b,0,a),a.dayResidue=100}.bind(this)),this.Tasks.forEach(function(a){a.StartDate=null,a.EndDate=null,a.Production=[]}),a){case"forward":var g=1;for(let a=0;a<this.Tasks.length;a++){var h=this.Tasks[a];null===h.ExOrder?(h.ExOrder=g++,h.InitialExOrder=h.ExOrder):g=h.ExOrder+1,h.DueDate!==f&&(null===this.MaxDate||h.DueDate>this.MaxDate)&&(this.MaxDate=h.DueDate);let b=h.Load*c*(1-h.Completion/100);for(h.StartDate=h.Resource.NextWorkableDay;100<=b;)h.Production.push(h.Resource.NextWorkableDay),h.Resource.NextWorkableDay=this.AddToWorkableDay(h.Resource.NextWorkableDay,1,h.Resource),b-=100;//scale / this.Resolution <=> fraction de journée qui ne doit pas être planifiée
b>c/this.Resolution&&(h.Production.push(h.Resource.NextWorkableDay),b>h.Resource.dayResidue?(h.Resource.NextWorkableDay=this.AddToWorkableDay(h.Resource.NextWorkableDay,1,h.Resource),h.Production.push(h.Resource.NextWorkableDay),h.Resource.dayResidue=h.Resource.dayResidue+100-b):h.Resource.dayResidue-=b,0===h.Resource.dayResidue&&(h.Resource.NextWorkableDay=this.AddToWorkableDay(h.Resource.NextWorkableDay,1,h.Resource),h.Resource.dayResidue=100)),h.EndDate=0<h.Production.length?h.Production[h.Production.length-1]:h.StartDate,(null===this.MaxDate||h.Resource.NextWorkableDay>this.MaxDate)&&(this.MaxDate=h.Resource.NextWorkableDay),(null===this.MinDate||h.StartDate<this.MinDate)&&(this.MinDate=h.StartDate)}}this.PlanningDuration=Date.now()-e},a.MbtPlanner=g;a.mbtpGetDate=d})(this);